on: [push, pull_request]

name: CI

jobs:
  dist:
    runs-on: ubuntu-latest
    env:
      CC: clang
      CC_LD: lld
      JOB: dist
      DISTOUT: ${{ github.workspace }}/dist

    steps:
    - name: Checkout Naev Repository 
      uses: actions/checkout@v2

    - name: Setup Build Environment
      run: |
        ./utils/ci/setupDeps.sh -r ${{ runner.os }} -j $JOB
    
    - name: Build Dist
      run: |
        ./utils/ci/mesonBuild.sh -r ${{ runner.os }} -j $JOB -o $DISTOUT

    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: naev-dist-${{ github.sha }}
        path: ${{ github.workspace }}/builddir/meson-dist/*
        if-no-files-found: error

  ci:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    needs: dist
    runs-on: ${{ matrix.os }}

    env:
      CC: clang
      CC_LD: lld
      JOB: ci
      DISTOUT: ${{ github.workspace }}/dist

    steps:
    - name: Setup Windows Build Environment
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: mingw-w64-x86_64-python mingw-w64-x86_64-python-pip mingw-w64-x86_64-clang mingw-w64-x86_64-pkg-config mingw-w64-x86_64-freetype mingw-w64-x86_64-fontconfig mingw-w64-x86_64-SDL2 mingw-w64-x86_64-SDL2_mixer mingw-w64-x86_64-SDL2_image mingw-w64-x86_64-openal mingw-w64-x86_64-libvorbismingw-w64-x86_64-libxml2 git tar
      if: ${{ matrix.os == 'windows-latest'}}

    - name: Get Source
      uses: actions/download-artifact@v2
      with:
        name: naev-dist-${{ github.sha }}

    - name: Extract Source
      run: |
        mkdir source
        tar -xf naev-*.tar.xz -C source --strip 1

    - name: Extract Source (Windows)
      run: |
        mkdir source
        tar -xf naev-*.tar.xz -C source --strip 1
      shell: msys2 {0}
      if: ${{ matrix.os == 'windows-latest'}}

    - name: Setup Build Environment
      run: |
        ./source/utils/ci/setupDeps.sh -r ${{ runner.os }} -j $JOB
      if: ${{ matrix.os != 'windows-latest'}}

    - name: Setup Build Environment (Windows)
      run: |
        ./source/utils/ci/setupDeps.sh -r ${{ runner.os }} -j $JOB
      shell: msys2 {0}
      if: ${{ matrix.os == 'windows-latest'}}

    - name: Build Naev
      run: |
        ./source/utils/ci/mesonBuild.sh -r ${{ runner.os }} -j $JOB -o $DISTOUT
      if: ${{ matrix.os != 'windows-latest'}}

    - name: Build Naev (Windows)
      run: |
        ./source/utils/ci/mesonBuild.sh -r ${{ runner.os }} -j $JOB -o $DISTOUT
      shell: msys2 {0}
      if: ${{ matrix.os == 'windows-latest'}}

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: naev-${{ runner.os }}-${{ github.sha }}
        path: ${{ github.workspace }}/dist/*
        if-no-files-found: error

  docs:
    needs: dist
    runs-on: ubuntu-latest
    env:
      CC: clang
      JOB: docs
      DISTOUT: ${{ github.workspace }}/dist

    steps:
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2.0.3
      with:
        key: ${{ secrets.SSH_KEY }}
        name: id_rsa # optional
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
      if: ${{ github.event_name == 'push' && github.repository == 'naev/naev' }}

    - name: Get Source
      uses: actions/download-artifact@v2
      with:
        name: naev-dist-${{ github.sha }}

    - name: Extract Source
      run: |
        mkdir source
        tar -xf naev-*.tar.xz -C source --strip 1

    - name: Setup Build Environment
      run: |
        ./source/utils/ci/setupDeps.sh -r ${{ runner.os }} -j $JOB
    
    - name: Build Docs
      run: |
        ./source/utils/ci/mesonBuild.sh -r ${{ runner.os }} -j $JOB -o $DISTOUT

    - name: Upload Lua Documentation
      run: rsync -e "ssh -o 'StrictHostKeyChecking no'" -rv --delete dist/docs/lua/ travis@iandouglasscott.com:/srv/naevdoc
      if: ${{ github.event_name == 'push' && github.repository == 'naev/naev' }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: naev-docs-${{ github.sha }}
        path: ${{ github.workspace }}/dist/docs/*
        if-no-files-found: error
